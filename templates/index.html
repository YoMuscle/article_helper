<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è«–æ–‡æ•‘ç«ç«™ - APA Citation Generator</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      background-color: #fafafa;
      color: #333;
      text-align: center;
      padding: 40px;
    }
    .container {
      max-width: 650px;
      margin: auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    textarea, input[type="text"] {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 15px;
      padding: 10px 25px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background-color: #0056b3; }
    #result { text-align: left; margin-top: 25px; }
    #suggestions {
      text-align: left;
      list-style: none;
      margin-top: 8px;
      padding: 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      max-height: 180px;
      overflow-y: auto;
    }
    #suggestions li {
      padding: 6px 10px;
      cursor: pointer;
    }
    #suggestions li:hover {
      background-color: #f1f1f1;
    }
    .loading {
      color: #666;
      font-style: italic;
      padding: 6px 10px;
    }
    .mode-indicator {
      font-size: 0.9em;
      color: #555;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ“š è«–æ–‡æ•‘ç«ç«™</h1>
    <p>è¼¸å…¥ <strong>DOI</strong> æˆ– <strong>é—œéµå­—</strong>ï¼ˆç³»çµ±æœƒè‡ªå‹•åˆ¤æ–·æ ¼å¼ï¼‰ï¼š</p>

    <input type="text" id="inputBox" placeholder="ä¾‹å¦‚ï¼š10.1080/1612197X.2024.2365374 æˆ– aerobic exercise cognition">
    <div class="mode-indicator" id="modeText">ç›®å‰ç‚ºï¼šè‡ªå‹•åµæ¸¬æ¨¡å¼</div>
    <ul id="suggestions"></ul>

    <button id="generateBtn" onclick="generateCitation()">ç”¢ç”Ÿ Citation</button>
    <div id="loading" style="display:none;">â³ æ­£åœ¨è™•ç†ä¸­...</div>
    <div id="result"></div>
  </div>

  <script>
    const inputBox = document.getElementById('inputBox');
    const suggestions = document.getElementById('suggestions');
    const loading = document.getElementById('loading');
    const modeText = document.getElementById('modeText');
    let typingTimer;
    const typingDelay = 400; // ms

    // åµæ¸¬è¼¸å…¥æ–‡å­—
    inputBox.addEventListener('input', (e) => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => handleInput(e.target.value.trim()), typingDelay);
    });

    async function handleInput(e) {
        const value = e.target.value.trim();
        const suggestions = document.getElementById('suggestions');
        const modeText = document.getElementById('modeText');

        if (!value) {
            suggestions.innerHTML = '';
            return;
        }

        // âœ… é¡¯ç¤º Loading æç¤º
        suggestions.innerHTML = '<li style="color:gray;">ğŸ” æ­£åœ¨æœå°‹ CrossRefï¼Œè«‹ç¨å€™...</li>';

        try {
            const response = await fetch(`/api/suggest_doi?prefix=${encodeURIComponent(value)}`);
            if (!response.ok) throw new Error("CrossRef å›æ‡‰éŒ¯èª¤");

            const data = await response.json();
            if (data.length === 0) {
            suggestions.innerHTML = '<li style="color:gray;">âš ï¸ æ²’æ‰¾åˆ°ç›¸é—œçµæœï¼Œè«‹å†è©¦è©¦å…¶ä»–é—œéµå­—ã€‚</li>';
            return;
            }

            // âœ… å»ºç«‹çµæœæ¸…å–®
            suggestions.innerHTML = data.map(d =>
            `<li onclick="fillDOI('${d.doi}')">
                <b>${d.title}</b><br>
                <small>${d.authors || ''} (${d.year || ''})<br>DOI: ${d.doi}</small>
            </li>`
            ).join('');

        } catch (error) {
            suggestions.innerHTML = '<li style="color:#c00;">âŒ CrossRef ç„¡æ³•é€£ç·šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</li>';
            console.warn("CrossRef é€£ç·šå¤±æ•—:", error);
        }
    }

    // ğŸš€ ç”¢ç”Ÿ Citation
    async function generateCitation() {
        let input = inputBox.value.trim();
        if (!input) return alert("è«‹è¼¸å…¥ DOI æˆ– Referenceï¼");

        // âœ… è‡ªå‹•æ¸…ç† DOI å‰ç¶´
        input = input.replace(/^https?:\/\/(dx\.)?doi\.org\//i, '');
        input = input.replace(/^doi:\/\//i, '');

        loading.style.display = 'block';
        document.getElementById('result').innerHTML = '';

        try {
            const res = await fetch('/api/generate_citation', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input })
            });
            const data = await res.json();
            loading.style.display = 'none';

            if (data.status === 'success') {
                suggestions.innerHTML = '';       // âœ… æ¸…é™¤èˆŠæç¤º
                modeText.innerText = "å·²æˆåŠŸç”¢ç”Ÿ Citation âœ…";

                document.getElementById('result').innerHTML = `
                <h2>âœ… çµæœ (${data.mode.toUpperCase()})</h2>

                <p>
                    <strong>Reference:</strong><br>
                    <span class="copyable" onclick="copyText(this)" title="é»ä¸€ä¸‹è¤‡è£½ Reference">
                    ${data.reference}
                    </span>
                </p>

                <p>
                    <strong>Parenthetical:</strong>
                    <span class="copyable" onclick="copyText(this)" title="é»ä¸€ä¸‹è¤‡è£½ Parenthetical Citation">
                    ${data.citations.parenthetical}
                    </span>
                </p>

                <p>
                    <strong>Narrative:</strong>
                    <span class="copyable" onclick="copyText(this)" title="é»ä¸€ä¸‹è¤‡è£½ Narrative Citation">
                    ${data.citations.narrative}
                    </span>
                </p>

                <p><small><i>${data.meta.journal || ''} | ${data.meta.publisher || ''}</i></small></p>
                `;
            } else {
                document.getElementById('result').innerHTML = `<p class="error">${data.message}</p>`;
            }
        } catch {
            loading.style.display = 'none';
            document.getElementById('result').innerHTML = `<p class="error">âš ï¸ ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>`;
        } 
    }

    function copyText(el) {
    const text = el.innerText;
    navigator.clipboard.writeText(text).then(() => {
        showCopyPopup("å·²è¤‡è£½ï¼");
    });
    }

    // âœ… é¡¯ç¤º pop-out æç¤º
    function showCopyPopup(msg) {
    let popup = document.createElement("div");
    popup.innerText = msg;
    popup.className = "copy-popup";
    document.body.appendChild(popup);

    // å‹•ç•«é€²å‡ºå ´
    setTimeout(() => popup.classList.add("show"), 10);
    setTimeout(() => {
        popup.classList.remove("show");
        setTimeout(() => popup.remove(), 300);
    }, 1500);
    }    
  </script>
</body>
</html>